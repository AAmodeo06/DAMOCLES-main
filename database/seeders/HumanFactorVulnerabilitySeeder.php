<?php

// REALIZZATO DA: Andrea Amodeo

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use Illuminate\Support\Str;
use App\Models\HumanFactor;
use App\Models\Vulnerability;

class HumanFactorVulnerabilitySeeder extends Seeder
{
    private array $links = [
        'Age (demographic factor)'                 => ['Phishing','Smishing','Social Engineering'],
        'Gender (demographic factor)'              => ['Phishing','Social Engineering'],
        'Education Level'                          => ['Phishing','Social Engineering'],
        'Agreeableness'                            => ['Phishing','Social Engineering','Vishing'],
        'Extroversion'                             => ['Social Engineering','Vishing'],
        'Conscientiousness'                        => ['Phishing','Spear Phishing'],
        'Neuroticism'                              => ['Phishing','Smishing','Social Engineering'],
        'Vigilance'                                => ['Phishing','Social Engineering','Spear Phishing'],
        'Misperception'                            => ['Phishing','Spear Phishing','Social Engineering'],
        'Uncertainty'                              => ['Phishing','Vishing','Social Engineering'],
        'Overconfidence'                           => ['Spear Phishing','Social Engineering'],
        'Perfectionism'                            => ['Phishing','Spear Phishing'],
        'Negativity bias'                          => ['Social Engineering','Phishing'],
        'Rank Effect'                              => ['Spear Phishing','Social Engineering'],
        'Anchoring bias'                           => ['Spear Phishing','Social Engineering'],
        'Limited attention /Focus'                 => ['Phishing','Smishing'],
        'Perception of small probabilities'        => ['Phishing','Spear Phishing'],
        'Preference for the present'               => ['Phishing','Business Email Compromise'],
        'Lack of Awareness'                        => ['Phishing','Smishing','Social Engineering'],
        'Imitation'                                => ['Social Engineering','Phishing'],
        'Asymmetric Information'                   => ['Phishing','Business Email Compromise','Social Engineering'],
        'Trust Propensity'                         => ['Phishing','Vishing','Social Engineering'],
        'Trust and Risk Perception'                => ['Phishing','Vishing'],
        'Authority'                                => ['Phishing','Business Email Compromise','Spear Phishing'],
        'Consistency'                              => ['Spear Phishing','Social Engineering'],
        'Liking'                                   => ['Social Engineering','Phishing'],
        'Scarcity'                                 => ['Phishing','Smishing'],
        'Sensitivity'                              => ['Social Engineering','Phishing'],
        'Induction/suggestion'                     => ['Social Engineering','Vishing'],
        'Insight/Lack of awareness'                => ['Phishing','Smishing','Social Engineering'],
        'Persistence'                              => ['Spear Phishing','Phishing'],
        'General Ability'                          => ['Phishing','Spear Phishing'],
        'Impulsivity'                              => ['Phishing','Smishing','Vishing'],
        'Distractibility'                          => ['Phishing','Smishing'],
        'Social Desirability'                      => ['Phishing','Social Engineering'],
        'Resistance'                               => ['Social Engineering'],
        'Self-efficacy'                            => ['Phishing','Spear Phishing'],
        'Self-esteem'                              => ['Social Engineering','Phishing'],
        'Empathy'                                  => ['Social Engineering','Vishing'],
        'Passive Aggressiveness'                   => ['Social Engineering'],
        'Inadequacy'                               => ['Phishing','Social Engineering'],
        'Pseudo Omnipotence'                       => ['Spear Phishing','Social Engineering'],
        'Invasion'                                 => ['Social Engineering'],
        'Behaviour Style (Conflict)'               => ['Social Engineering','Spear Phishing'],
        'Detachment'                               => ['Social Engineering'],
        'Emotional Sensitivity'                    => ['Social Engineering','Phishing'],
        'Abandonment and Helplessness'             => ['Social Engineering'],
        'Emotional inhibition'                     => ['Social Engineering'],
        'Mental Ruminations (Overthinking)'        => ['Social Engineering'],
        'Concern with Envy or Shame'               => ['Social Engineering'],
    ];

    public function run(): void
    {
        $vulnByLowerName = Vulnerability::all()
            ->keyBy(fn($v) => Str::lower($v->name));

        $okCount = 0;
        $skipHF  = [];
        $skipVuln = [];

        foreach ($this->links as $hfName => $vulnNames) {
            $hf = HumanFactor::where('name', $hfName)->first();

            if (!$hf) {
                $hf = HumanFactor::where('slug', Str::slug($hfName))->first();
            }

            if (!$hf) {
                $skipHF[] = $hfName;
                continue;
            }

            $ids = [];
            foreach ($vulnNames as $vn) {
                $key = Str::lower($vn);
                $v = $vulnByLowerName[$key] ?? null;

                if (!$v) {
                    $skipVuln[] = $vn;
                    continue;
                }
                $ids[] = $v->id;
            }

            if (!empty($ids)) {
                $hf->vulnerabilities()->syncWithoutDetaching($ids);
                $okCount++;
            }
        }

        $this->command->info("Collegamenti HF↔Vulnerabilità creati/aggiornati per {$okCount} human factors.");
        if (!empty($skipHF)) {
            $this->command->warn('HF non trovati (controlla nomi/slug): '.implode(' | ', array_unique($skipHF)));
        }
        if (!empty($skipVuln)) {
            $this->command->warn('Vulnerabilità non trovate (controlla VulnerabilitiesSeeder): '.implode(' | ', array_unique($skipVuln)));
        }
    }
}
